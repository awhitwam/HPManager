<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPManager - Heat Pump Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .last-update {
            float: right;
            color: #999;
            font-size: 12px;
            margin-top: 10px;
        }

        .hp-timeframe {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            font-size: 11px;
            color: #9ca3af;
        }

        .hp-timeframe input[type="range"] {
            width: 100px;
            height: 4px;
            accent-color: #667eea;
        }

        .hp-timeframe-label {
            min-width: 42px;
            font-variant-numeric: tabular-nums;
        }

        .heat-pumps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .heat-pump-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }


        .hp-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .hp-header-left {
            flex: 0 0 auto;
        }

        .hp-name {
            font-size: 22px;
            font-weight: 600;
            color: #333;
        }

        .hp-last-update {
            font-size: 12px;
            font-weight: 400;
            color: #9ca3af;
            margin-left: 8px;
        }

        .hp-location {
            font-size: 14px;
            color: #666;
            margin-top: 3px;
        }

        .hp-status-card {
            flex: 1;
            margin: 0 15px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 14px;
            min-width: 0;
        }

        .hp-status-card .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            font-size: 13px;
        }

        .hp-status-card .status-row + .status-row {
            border-top: 1px solid #e9ecef;
        }

        .hp-status-card .status-label {
            font-weight: 600;
            color: #333;
        }

        .hp-status-card .status-label.active {
            color: #16a34a;
        }

        .hp-status-card .status-label.idle {
            color: #9ca3af;
        }

        .hp-status-card .status-since {
            color: #6b7280;
            font-size: 12px;
            margin-left: 10px;
            white-space: nowrap;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-online {
            background: #10b981;
            color: white;
        }

        .status-offline {
            background: #ef4444;
            color: white;
        }

        .status-warning {
            background: #f59e0b;
            color: white;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: grab;
            transition: opacity 0.2s;
        }

        .metric-dragging {
            opacity: 0.4;
        }

        .metric-drag-over {
            outline: 2px dashed #667eea;
            outline-offset: -2px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .metric-unit {
            font-size: 14px;
            color: #999;
            margin-left: 4px;
        }

        .metric-large {
            grid-column: span 2;
        }

        .metric.power {
            border-left-color: #f59e0b;
        }

        .metric.temp {
            border-left-color: #ef4444;
        }

        .metric.cop {
            border-left-color: #10b981;
        }

        .metric.status {
            border-left-color: #8b5cf6;
        }

        .status-flags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .status-flag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-flag.active {
            background: #dcfce7;
            color: #166534;
        }

        .status-flag.idle {
            background: #f3f4f6;
            color: #9ca3af;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .refresh-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
            transition: background 0.2s;
        }

        .refresh-button:hover {
            background: #5568d3;
        }

        .auto-refresh {
            display: inline-block;
            margin-left: 10px;
            font-size: 12px;
            color: #10b981;
        }

        /* Management UI Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-grafana {
            background: #F46800;
            color: white;
            text-decoration: none;
        }

        .btn-grafana:hover {
            background: #e05e00;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Restart Banner */
        .restart-banner {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .restart-banner.show {
            display: flex;
        }

        .restart-banner-message {
            font-size: 14px;
            color: #92400e;
            font-weight: 500;
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 10px;
            padding: 0;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-input[readonly] {
            background: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }

        .form-input.error {
            border-color: #ef4444;
        }

        .form-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .form-error.show {
            display: block;
        }

        .form-checkbox {
            margin-right: 8px;
        }

        .form-help {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e5e7eb;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        /* Heat Pump List in Management Modal */
        .hp-list {
            list-style: none;
        }

        .hp-list-item {
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hp-list-info {
            flex: 1;
        }

        .hp-list-name {
            font-weight: 600;
            color: #333;
        }

        .hp-list-details {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        .hp-list-actions {
            display: flex;
            gap: 8px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            border-left: 4px solid #10b981;
        }

        .toast-error {
            border-left: 4px solid #ef4444;
        }

        .toast-warning {
            border-left: 4px solid #f59e0b;
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        .toast-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 14px;
        }

        /* Settings - Field Checklist */
        .field-category {
            margin-bottom: 15px;
        }

        .field-category-title {
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .pump-tab {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.15s;
        }

        .pump-tab:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .pump-tab.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .field-checkbox-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .field-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 6px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.15s;
        }

        .field-checkbox-item:hover {
            background: #e9ecef;
        }

        .field-checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        /* Sparkline canvas */
        .sparkline {
            display: block;
            margin-top: 8px;
            width: 100%;
            height: 44px;
            border-radius: 4px;
        }

        /* Legacy status flag badges (kept for fault status) */
        .status-flags .status-flag {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .heat-pumps-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .metric-large {
                grid-column: span 1;
            }

            .field-checkbox-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Toast Notifications Container -->
        <div class="toast-container" id="toast-container"></div>

        <header>
            <div class="header-left">
                <h1>üî• HPManager Dashboard</h1>
                <p class="subtitle">Real-time heat pump monitoring</p>
            </div>
            <div class="header-right">
                <a href="/grafana" target="_blank" class="btn btn-grafana" id="grafana-link">
                    Grafana
                </a>
                <button class="btn btn-secondary" onclick="openSettingsModal()">
                    Settings
                </button>
                <button class="btn btn-primary" onclick="openManageModal()">
                    Manage Heat Pumps
                </button>
            </div>
        </header>

        <!-- Restart Banner -->
        <div class="restart-banner" id="restart-banner">
            <div class="restart-banner-message">
                ‚ö†Ô∏è Configuration changed. Restart collector to apply changes.
            </div>
            <button class="btn btn-success btn-small" onclick="restartCollector()">
                Restart Collector
            </button>
        </div>

        <div class="heat-pumps-grid" id="heat-pumps-container">
            {% if heat_pumps %}
                {% for hp in heat_pumps %}
                <div class="heat-pump-card" data-hp-card="{{ hp.id }}">
                    <div class="hp-header">
                        <div class="hp-header-left">
                            <div class="hp-name">{{ hp.name }} <span class="hp-last-update" data-hp-timestamp="{{ hp.id }}" data-ts="{{ hp.data.timestamp or '' }}">--</span></div>
                            <div class="hp-location">üìç {{ hp.location }}</div>
                            {% set m = hp.data.metrics or {} %}
                            <div class="hp-header-mode" data-hp="{{ hp.id }}" style="font-size: 13px; color: #8b5cf6; font-weight: 600; margin-top: 4px;">{{ m.operating_mode|default('', true) }}</div>
                            {% set hp_tf = sparkline_minutes_per_pump.get(hp.id, sparkline_minutes) %}
                            <div class="hp-timeframe">
                                <span>Timeframe</span>
                                <input type="range" class="timeframe-slider" data-hp="{{ hp.id }}"
                                       min="5" max="480" step="5" value="{{ hp_tf }}">
                                <span class="hp-timeframe-label" data-hp-tf-label="{{ hp.id }}">{{ hp_tf }} min</span>
                            </div>
                        </div>
                        <div class="hp-status-card" data-hp-status-card="{{ hp.id }}">
                            <div class="status-row" data-flag="compressor_running">
                                <span class="status-label {{ 'active' if m.compressor_running else 'idle' }}">Compressor {{ 'ON' if m.compressor_running else 'OFF' }}</span>
                                <span class="status-since" data-flag-since="compressor_running"></span>
                            </div>
                            <div class="status-row" data-flag="hc1_pump" {% if not m.hc1_pump %}style="display:none"{% endif %}>
                                <span class="status-label active">HC1 Pump</span>
                                <span class="status-since" data-flag-since="hc1_pump"></span>
                            </div>
                            <div class="status-row" data-flag="hp_heating_mode" {% if not m.hp_heating_mode %}style="display:none"{% endif %}>
                                <span class="status-label active">Heating</span>
                                <span class="status-since" data-flag-since="hp_heating_mode"></span>
                            </div>
                            <div class="status-row" data-flag="hp_dhw_mode" {% if not m.hp_dhw_mode %}style="display:none"{% endif %}>
                                <span class="status-label active">DHW</span>
                                <span class="status-since" data-flag-since="hp_dhw_mode"></span>
                            </div>
                            <div class="status-row" data-flag="defrost_mode" {% if not m.defrost_mode %}style="display:none"{% endif %}>
                                <span class="status-label active" style="color:#dc2626;">Defrost</span>
                                <span class="status-since" data-flag-since="defrost_mode"></span>
                            </div>
                            <div class="status-row" data-flag="summer_mode" {% if not m.summer_mode %}style="display:none"{% endif %}>
                                <span class="status-label active">Summer</span>
                                <span class="status-since" data-flag-since="summer_mode"></span>
                            </div>
                            <div class="status-row" data-flag="cooling_mode" {% if not m.cooling_mode %}style="display:none"{% endif %}>
                                <span class="status-label active">Cooling</span>
                                <span class="status-since" data-flag-since="cooling_mode"></span>
                            </div>
                            <div class="status-row" data-flag="nhz_stages_running" {% if not m.nhz_stages_running %}style="display:none"{% endif %}>
                                <span class="status-label active" style="color:#92400e;">NHZ Backup</span>
                                <span class="status-since" data-flag-since="nhz_stages_running"></span>
                            </div>
                        </div>
                        <div class="status-badge {% if hp.data.timestamp %}status-online{% else %}status-offline{% endif %}" data-hp-badge="{{ hp.id }}">
                            {% if hp.data.timestamp %}Online{% else %}Offline{% endif %}
                        </div>
                    </div>

                    {% if hp.data.metrics %}
                    {# Field metadata for data-driven display #}
                    {% set field_meta = {
                        "outside_temperature": {"label": "Outside Temp", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "actual_temperature_hk1": {"label": "Flow Temp (HK1)", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "set_temperature_hk1": {"label": "Set Temp HK1", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "actual_return_temperature": {"label": "Return Temp", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "actual_buffer_temperature": {"label": "Buffer Temp", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "set_buffer_temperature": {"label": "Set Buffer Temp", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "actual_dhw_temperature": {"label": "DHW Temp", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "set_dhw_temperature": {"label": "Set DHW Temp", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "compressor_inlet_temperature": {"label": "Comp. Inlet Temp", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "hp_flow_temperature": {"label": "HP Flow Temp", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "hot_gas_temperature": {"label": "Hot Gas Temp", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "low_pressure": {"label": "Low Pressure", "css": "status", "unit": "bar", "decimals": 2},
                        "mean_pressure": {"label": "Mean Pressure", "css": "status", "unit": "bar", "decimals": 2},
                        "high_pressure": {"label": "High Pressure", "css": "status", "unit": "bar", "decimals": 2},
                        "wp_water_flow_rate": {"label": "Water Flow", "css": "status", "unit": "l/min", "decimals": 1},
                        "operating_mode": {"label": "Operating Mode", "css": "status", "unit": "", "decimals": 0, "is_text": true},
                        "comfort_temperature_hk1": {"label": "Comfort Temp HK1", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "eco_temperature_hk1": {"label": "ECO Temp HK1", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "heating_curve_rise_hk1": {"label": "Heating Curve Rise", "css": "status", "unit": "", "decimals": 2},
                        "comfort_temperature_dhw": {"label": "Comfort Temp DHW", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "eco_temperature_dhw": {"label": "ECO Temp DHW", "css": "temp", "unit": "¬∞C", "decimals": 1},
                        "inverter_power": {"label": "Inverter Power", "css": "power", "unit": "kW", "decimals": 2, "large": true},
                        "heat_meter_heating_day": {"label": "Heat Heating (Day)", "css": "power", "unit": "kWh", "decimals": 0},
                        "heat_meter_dhw_day": {"label": "Heat DHW (Day)", "css": "power", "unit": "kWh", "decimals": 0},
                        "power_consumption_heating_day": {"label": "Power Heating (Day)", "css": "power", "unit": "kWh", "decimals": 0},
                        "power_consumption_dhw_day": {"label": "Power DHW (Day)", "css": "power", "unit": "kWh", "decimals": 0},
                    } %}
                    <div class="metrics-grid">
                        {% for field_name in hp.visible_fields %}
                            {% if field_name in field_meta %}
                                {% set meta = field_meta[field_name] %}
                                <div class="metric {{ meta.css }}{% if meta.large is defined and meta.large %} metric-large{% endif %}" data-field="{{ field_name }}" draggable="true">
                                    <div class="metric-label">{{ meta.label }}</div>
                                    <div class="metric-value" data-hp="{{ hp.id }}" data-field="{{ field_name }}">
                                        {% if hp.data.metrics[field_name] is defined %}
                                            {% if meta.is_text is defined and meta.is_text %}
                                                <span style="font-size: 16px;">{{ hp.data.metrics[field_name] }}</span>
                                            {% elif meta.decimals == 0 %}
                                                {{ hp.data.metrics[field_name]|int }}
                                                {% if meta.unit %}<span class="metric-unit">{{ meta.unit }}</span>{% endif %}
                                            {% elif meta.decimals == 1 %}
                                                {{ "%.1f"|format(hp.data.metrics[field_name]) }}
                                                <span class="metric-unit">{{ meta.unit }}</span>
                                            {% else %}
                                                {{ "%.2f"|format(hp.data.metrics[field_name]) }}
                                                <span class="metric-unit">{{ meta.unit }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span style="font-size: 16px; color: #999;">N/A</span>
                                        {% endif %}
                                    </div>
                                    {% if meta.is_text is not defined or not meta.is_text %}
                                    <canvas class="sparkline" data-hp="{{ hp.id }}" data-field="{{ field_name }}"
                                            width="240" height="44"></canvas>
                                    {% endif %}
                                </div>
                            {% elif field_name == "operating_status" %}
                                {# Operating status flags now shown in header ‚Äî skip here #}
                            {% elif field_name == "fault_status" %}
                                {# Special: fault status shown as alert when fault detected #}
                                <div class="metric status metric-large" data-field="fault_status" data-hp-fault="{{ hp.id }}" draggable="true" style="border: 2px solid #ef4444;{% if not (hp.data.metrics.fault_status is defined and hp.data.metrics.fault_status == 'Fault') %} display:none;{% endif %}">
                                    <div class="metric-label" style="color: #991b1b;">Fault Status</div>
                                    <div class="status-flags">
                                        <span class="status-flag active" style="background:#fee2e2;color:#991b1b;">FAULT DETECTED</span>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}

                        {# COP always shown if available #}
                        {% if hp.cop %}
                        <div class="metric cop metric-large">
                            <div class="metric-label">COP (Coefficient of Performance)</div>
                            <div class="metric-value">
                                {{ "%.2f"|format(hp.cop) }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="no-data">
                        <p>No data available for this heat pump</p>
                        <p style="font-size: 12px; margin-top: 10px; color: #ccc;">
                            Check collector service and InfluxDB connection
                        </p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="heat-pump-card">
                    <div class="no-data">
                        <p>No heat pumps configured</p>
                        <p style="font-size: 12px; margin-top: 10px; color: #ccc;">
                            Check config/heatpumps.yml
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>

        <div style="text-align: center;">
            <button class="refresh-button" onclick="refreshDashboard()">üîÑ Refresh Now</button>
        </div>

        <footer>
            <p>HPManager v1.0 | Powered by InfluxDB & Grafana</p>
            <p style="margin-top: 4px; font-size: 11px; opacity: 0.7;">&copy; A Whitwam 2026</p>
        </footer>
    </div>

    <!-- Management Modal -->
    <div class="modal-overlay" id="manage-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Manage Heat Pumps</div>
                <button class="modal-close" onclick="closeManageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="openAddModal()">+ Add New Heat Pump</button>
                </div>
                <ul class="hp-list" id="hp-manage-list">
                    <!-- Populated by JavaScript -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Add/Edit Heat Pump Modal -->
    <div class="modal-overlay" id="form-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="form-modal-title">Add Heat Pump</div>
                <button class="modal-close" onclick="closeFormModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="hp-form" onsubmit="saveHeatPump(event)">
                    <div class="form-group">
                        <label class="form-label" for="hp-id">ID *</label>
                        <input type="text" id="hp-id" name="id" class="form-input" required
                               pattern="[a-z0-9_-]+" title="Lowercase letters, numbers, underscores, and hyphens only">
                        <div class="form-help">Unique identifier (lowercase, alphanumeric, underscore, hyphen)</div>
                        <div class="form-error" id="error-id"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="hp-name">Name *</label>
                        <input type="text" id="hp-name" name="name" class="form-input" required maxlength="100">
                        <div class="form-error" id="error-name"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="hp-location">Location *</label>
                        <input type="text" id="hp-location" name="location" class="form-input" required maxlength="100">
                        <div class="form-error" id="error-location"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="hp-model">Model *</label>
                        <select id="hp-model" name="model" class="form-input" required>
                            <option value="">Select a model...</option>
                            <!-- Populated by JavaScript -->
                        </select>
                        <div class="form-error" id="error-model"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="hp-enabled" name="enabled" class="form-checkbox" checked>
                            Enabled
                        </label>
                        <div class="form-help">Uncheck to disable data collection for this heat pump</div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Modbus TCP Configuration</div>

                        <div class="form-group">
                            <label class="form-label" for="hp-host">IP Address *</label>
                            <input type="text" id="hp-host" name="host" class="form-input" required
                                   pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                                   placeholder="192.168.1.100" title="Valid IPv4 address">
                            <div class="form-error" id="error-host"></div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="hp-port">Port</label>
                                <input type="number" id="hp-port" name="port" class="form-input" value="502" min="1" max="65535">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="hp-unit-id">Unit ID</label>
                                <input type="number" id="hp-unit-id" name="unit_id" class="form-input" value="1" min="1" max="247">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="hp-timeout">Timeout (s)</label>
                                <input type="number" id="hp-timeout" name="timeout" class="form-input" value="5" min="0.1" step="0.1">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="hp-retries">Retries</label>
                                <input type="number" id="hp-retries" name="retries" class="form-input" value="3" min="0">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="hp-retry-delay">Retry Delay (s)</label>
                            <input type="number" id="hp-retry-delay" name="retry_delay" class="form-input" value="1" min="0.1" step="0.1">
                        </div>
                    </div>

                    <div class="form-section" id="display-fields-section" style="display: none;">
                        <div class="form-section-title">Displayed Fields</div>
                        <div class="form-help" style="margin-bottom: 10px;">
                            Choose which fields appear on this heat pump's dashboard card.
                        </div>
                        <div id="hp-fields-checklist">
                            <div style="text-align: center; padding: 20px; color: #999;">Loading fields...</div>
                        </div>
                    </div>

                    <input type="hidden" id="edit-mode" value="false">
                    <input type="hidden" id="original-id" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeFormModal()">Cancel</button>
                <button type="submit" form="hp-form" class="btn btn-primary" id="save-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">Confirm Delete</div>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete heat pump <strong id="delete-hp-name"></strong>?</p>
                <p style="font-size: 12px; color: #6b7280; margin-top: 10px;">
                    ‚ö†Ô∏è This action cannot be undone. Historical data in InfluxDB will be retained.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Collector Settings -->
                <div class="form-group">
                    <label class="form-label" for="setting-poll-interval">
                        Poll Interval (seconds)
                    </label>
                    <input type="number" id="setting-poll-interval" class="form-input"
                           min="5" max="120" step="1" value="10">
                    <div class="form-help">
                        How often the collector reads data from heat pumps.
                        Changing this requires a collector restart.
                    </div>
                </div>

                <!-- Display Settings -->
                <div class="form-section">
                    <div class="form-section-title">Display Settings</div>
                    <div class="form-group">
                        <label class="form-label" for="setting-refresh-interval">
                            Screen Refresh Rate (seconds)
                        </label>
                        <input type="number" id="setting-refresh-interval" class="form-input"
                               min="5" max="120" step="1" value="10">
                        <div class="form-help">
                            How often the dashboard page refreshes to show new data.
                        </div>
                    </div>
                </div>

                <!-- Sparkline Settings -->
                <div class="form-group" style="margin-top: 15px;">
                    <label class="form-label" for="setting-sparkline-minutes">
                        Sparkline Time Window (minutes)
                    </label>
                    <input type="number" id="setting-sparkline-minutes" class="form-input"
                           min="5" max="480" step="5" value="30">
                    <div class="form-help">
                        How many minutes of history to show in the sparkline graphs next to each metric.
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                <button type="button" class="btn btn-primary" id="settings-save-btn" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let availableModels = [];
        let allHeatPumps = [];
        let deleteTarget = null;
        let autoRefreshInterval = null;
        let pendingReload = false;

        // Safe reload: waits until no modals are open
        function scheduleReload() {
            pendingReload = true;
            function tryReload() {
                if (document.querySelector('.modal-overlay.show')) {
                    setTimeout(tryReload, 500);
                } else {
                    location.reload();
                }
            }
            setTimeout(tryReload, 1000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Set Grafana link to same host on port 3000
            document.getElementById('grafana-link').href =
                `${window.location.protocol}//${window.location.hostname}:3000`;

            loadModels();
            checkRestartNeeded();
            startAutoRefresh();
            loadSparklines();
            loadStateChanges();
            startLastUpdateTimer();
            initMetricDragAndDrop();
            initTimeframeSliders();
        });

        // Server-side settings
        const SERVER_REFRESH_INTERVAL = {{ refresh_interval }};
        const DEFAULT_SPARKLINE_MINUTES = {{ sparkline_minutes }};
        let sparklineMinutesPerPump = {{ sparkline_minutes_per_pump | tojson }};

        // Field metadata for JS-side formatting (mirrors Jinja2 field_meta)
        const FIELD_META = {
            outside_temperature: { unit: '¬∞C', decimals: 1 },
            actual_temperature_hk1: { unit: '¬∞C', decimals: 1 },
            set_temperature_hk1: { unit: '¬∞C', decimals: 1 },
            actual_return_temperature: { unit: '¬∞C', decimals: 1 },
            actual_buffer_temperature: { unit: '¬∞C', decimals: 1 },
            set_buffer_temperature: { unit: '¬∞C', decimals: 1 },
            actual_dhw_temperature: { unit: '¬∞C', decimals: 1 },
            set_dhw_temperature: { unit: '¬∞C', decimals: 1 },
            compressor_inlet_temperature: { unit: '¬∞C', decimals: 1 },
            hp_flow_temperature: { unit: '¬∞C', decimals: 1 },
            hot_gas_temperature: { unit: '¬∞C', decimals: 1 },
            low_pressure: { unit: 'bar', decimals: 2 },
            mean_pressure: { unit: 'bar', decimals: 2 },
            high_pressure: { unit: 'bar', decimals: 2 },
            wp_water_flow_rate: { unit: 'l/min', decimals: 1 },
            operating_mode: { unit: '', decimals: 0, is_text: true },
            comfort_temperature_hk1: { unit: '¬∞C', decimals: 1 },
            eco_temperature_hk1: { unit: '¬∞C', decimals: 1 },
            heating_curve_rise_hk1: { unit: '', decimals: 2 },
            comfort_temperature_dhw: { unit: '¬∞C', decimals: 1 },
            eco_temperature_dhw: { unit: '¬∞C', decimals: 1 },
            inverter_power: { unit: 'kW', decimals: 2 },
            heat_meter_heating_day: { unit: 'kWh', decimals: 0 },
            heat_meter_dhw_day: { unit: 'kWh', decimals: 0 },
            power_consumption_heating_day: { unit: 'kWh', decimals: 0 },
            power_consumption_dhw_day: { unit: 'kWh', decimals: 0 },
        };

        // Status flags that appear in the header
        const STATUS_FLAGS = [
            { key: 'compressor_running', label_on: 'Compressor ON', label_off: 'Compressor OFF', always_show: true },
            { key: 'hp_heating_mode', label_on: 'Heating' },
            { key: 'hp_dhw_mode', label_on: 'DHW' },
            { key: 'hc1_pump', label_on: 'HC1 Pump' },
            { key: 'defrost_mode', label_on: 'Defrost' },
            { key: 'summer_mode', label_on: 'Summer' },
            { key: 'cooling_mode', label_on: 'Cooling' },
            { key: 'nhz_stages_running', label_on: 'NHZ Backup' },
        ];

        // Auto-refresh management
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                const anyModalOpen = document.querySelector('.modal-overlay.show');
                if (!anyModalOpen) {
                    refreshDashboard();
                }
            }, SERVER_REFRESH_INTERVAL * 1000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // --- Last update countdown timer ---
        function startLastUpdateTimer() {
            updateLastUpdateDisplays();
            setInterval(updateLastUpdateDisplays, 1000);
        }

        function updateLastUpdateDisplays() {
            document.querySelectorAll('[data-hp-timestamp]').forEach(el => {
                const ts = el.dataset.ts;
                if (!ts) { el.textContent = '--'; return; }
                const secs = Math.round((Date.now() - new Date(ts).getTime()) / 1000);
                if (secs < 0 || isNaN(secs)) { el.textContent = '--'; return; }
                el.textContent = secs + 's ago';
            });
        }

        // --- Per-pump timeframe sliders ---
        function initTimeframeSliders() {
            document.querySelectorAll('.timeframe-slider').forEach(slider => {
                const hpId = slider.dataset.hp;
                const label = document.querySelector(`[data-hp-tf-label="${hpId}"]`);

                slider.addEventListener('input', () => {
                    label.textContent = slider.value + ' min';
                });

                slider.addEventListener('change', () => {
                    const mins = parseInt(slider.value);
                    sparklineMinutesPerPump[hpId] = mins;
                    loadSparklineForPump(hpId);
                    saveTimeframeForPump(hpId, mins);
                });
            });
        }

        async function saveTimeframeForPump(hpId, minutes) {
            try {
                const settingsRes = await fetch('/api/settings');
                const current = await settingsRes.json();
                const timeframes = current.display.sparkline_minutes_per_pump || {};
                timeframes[hpId] = minutes;

                await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        collector: current.collector,
                        display: {
                            refresh_interval: current.display.refresh_interval,
                            sparkline_minutes: current.display.sparkline_minutes || DEFAULT_SPARKLINE_MINUTES,
                            sparkline_minutes_per_pump: timeframes,
                            visible_fields: current.display.visible_fields || {},
                        }
                    })
                });
            } catch (e) {
                console.error('Failed to save timeframe:', e);
            }
        }

        // --- Drag-and-drop metric tile reordering ---
        let draggedMetric = null;
        let dragSourceGrid = null;

        function initMetricDragAndDrop() {
            document.querySelectorAll('.metrics-grid').forEach(grid => {
                grid.addEventListener('dragstart', (e) => {
                    const tile = e.target.closest('.metric');
                    if (!tile) return;
                    draggedMetric = tile;
                    dragSourceGrid = grid;
                    tile.classList.add('metric-dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                grid.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const target = e.target.closest('.metric');
                    if (!target || target === draggedMetric || grid !== dragSourceGrid) return;
                    grid.querySelectorAll('.metric-drag-over').forEach(el => el.classList.remove('metric-drag-over'));
                    target.classList.add('metric-drag-over');
                });

                grid.addEventListener('dragleave', (e) => {
                    const target = e.target.closest('.metric');
                    if (target) target.classList.remove('metric-drag-over');
                });

                grid.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (grid !== dragSourceGrid) return;
                    const target = e.target.closest('.metric');
                    if (!target || !draggedMetric || target === draggedMetric) return;

                    // Insert before or after based on cursor position
                    const rect = target.getBoundingClientRect();
                    const midX = rect.left + rect.width / 2;
                    if (e.clientX < midX) {
                        grid.insertBefore(draggedMetric, target);
                    } else {
                        grid.insertBefore(draggedMetric, target.nextSibling);
                    }

                    target.classList.remove('metric-drag-over');
                    saveMetricOrder(grid);
                });

                grid.addEventListener('dragend', () => {
                    if (draggedMetric) draggedMetric.classList.remove('metric-dragging');
                    grid.querySelectorAll('.metric-drag-over').forEach(el => el.classList.remove('metric-drag-over'));
                    draggedMetric = null;
                    dragSourceGrid = null;
                });
            });
        }

        async function saveMetricOrder(grid) {
            // Find which heat pump this grid belongs to
            const card = grid.closest('[data-hp-card]');
            if (!card) return;
            const hpId = card.dataset.hpCard;

            // Read new field order from DOM
            const fields = Array.from(grid.querySelectorAll('.metric[data-field]'))
                .map(el => el.dataset.field);

            try {
                const settingsRes = await fetch('/api/settings');
                const current = await settingsRes.json();
                const visibleFields = current.display.visible_fields || {};
                visibleFields[hpId] = fields;

                await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        collector: current.collector,
                        display: {
                            refresh_interval: current.display.refresh_interval,
                            sparkline_minutes: current.display.sparkline_minutes || 30,
                            visible_fields: visibleFields,
                        }
                    })
                });
            } catch (e) {
                console.error('Failed to save metric order:', e);
                showToast('Failed to save field order', 'error');
            }
        }

        // AJAX dashboard refresh ‚Äî updates values + sparklines without page reload
        async function refreshDashboard() {
            try {
                const response = await fetch('/api/heatpumps');
                const data = await response.json();
                const pumps = data.heat_pumps || [];

                for (const hp of pumps) {
                    const metrics = (hp.data && hp.data.metrics) || {};
                    const hasTimestamp = hp.data && hp.data.timestamp;

                    // Update last-update timestamp
                    const tsEl = document.querySelector(`[data-hp-timestamp="${hp.id}"]`);
                    if (tsEl) {
                        tsEl.dataset.ts = hasTimestamp ? hp.data.timestamp : '';
                    }

                    // Update online/offline badge
                    const badge = document.querySelector(`[data-hp-badge="${hp.id}"]`);
                    if (badge) {
                        badge.textContent = hasTimestamp ? 'Online' : 'Offline';
                        badge.className = 'status-badge ' + (hasTimestamp ? 'status-online' : 'status-offline');
                    }

                    // Update operating mode in header
                    const modeEl = document.querySelector(`.hp-header-mode[data-hp="${hp.id}"]`);
                    if (modeEl) {
                        modeEl.textContent = metrics.operating_mode || '';
                    }

                    // Update status card rows
                    const statusCard = document.querySelector(`[data-hp-status-card="${hp.id}"]`);
                    if (statusCard) {
                        for (const flag of STATUS_FLAGS) {
                            const row = statusCard.querySelector(`[data-flag="${flag.key}"]`);
                            if (!row) continue;
                            const val = !!metrics[flag.key];
                            const labelEl = row.querySelector('.status-label');
                            if (flag.always_show) {
                                row.style.display = '';
                                if (labelEl) {
                                    labelEl.className = 'status-label ' + (val ? 'active' : 'idle');
                                    labelEl.textContent = val ? flag.label_on : flag.label_off;
                                }
                            } else {
                                row.style.display = val ? '' : 'none';
                                if (labelEl) {
                                    labelEl.className = 'status-label ' + (val ? 'active' : 'idle');
                                }
                            }
                        }
                    }

                    // Update metric values
                    const valueEls = document.querySelectorAll(`.metric-value[data-hp="${hp.id}"]`);
                    for (const el of valueEls) {
                        const field = el.dataset.field;
                        const meta = FIELD_META[field];
                        if (!meta) continue;

                        const val = metrics[field];
                        if (val === undefined || val === null) {
                            el.innerHTML = '<span style="font-size: 16px; color: #999;">N/A</span>';
                        } else if (meta.is_text) {
                            el.innerHTML = `<span style="font-size: 16px;">${val}</span>`;
                        } else {
                            const formatted = meta.decimals === 0
                                ? Math.round(val)
                                : Number(val).toFixed(meta.decimals);
                            const unitHtml = meta.unit
                                ? `<span class="metric-unit">${meta.unit}</span>`
                                : '';
                            el.innerHTML = `${formatted} ${unitHtml}`;
                        }
                    }

                    // Update fault status
                    const faultEl = document.querySelector(`[data-hp-fault="${hp.id}"]`);
                    if (faultEl) {
                        faultEl.style.display = (metrics.fault_status === 'Fault') ? '' : 'none';
                    }
                }

                // Refresh sparklines and state change timestamps
                await Promise.all([loadSparklines(), loadStateChanges()]);

            } catch (err) {
                console.error('Dashboard refresh failed:', err);
            }
        }

        // --- State change timestamps ---

        function formatSinceTime(isoString) {
            const d = new Date(isoString);
            const now = new Date();
            const diffMs = now - d;
            const diffMins = Math.floor(diffMs / 60000);
            const hh = d.getHours().toString().padStart(2, '0');
            const mm = d.getMinutes().toString().padStart(2, '0');

            // If more than 24h ago, show date too
            if (diffMins > 1440) {
                const dd = d.getDate().toString().padStart(2, '0');
                const mo = (d.getMonth() + 1).toString().padStart(2, '0');
                return `${dd}/${mo} ${hh}:${mm}`;
            }
            return `${hh}:${mm}`;
        }

        async function loadStateChanges() {
            // Find all heat pump cards
            const cards = document.querySelectorAll('[data-hp-card]');
            for (const card of cards) {
                const hpId = card.dataset.hpCard;
                try {
                    const res = await fetch(`/api/heatpumps/${hpId}/state-changes`);
                    const data = await res.json();
                    updateStateChangeTimes(hpId, data.fields || {});
                } catch (err) {
                    console.error(`Failed to load state changes for ${hpId}:`, err);
                }
            }
        }

        function updateStateChangeTimes(hpId, fields) {
            const statusCard = document.querySelector(`[data-hp-status-card="${hpId}"]`);
            if (!statusCard) return;

            for (const [fieldName, info] of Object.entries(fields)) {
                const sinceEl = statusCard.querySelector(`[data-flag-since="${fieldName}"]`);
                if (sinceEl && info.since) {
                    sinceEl.textContent = `since ${formatSinceTime(info.since)}`;
                }
            }
        }

        // --- Sparkline rendering ---

        // Color map for sparkline lines based on CSS class
        const SPARKLINE_COLORS = {
            temp: { line: '#ef4444', fill: 'rgba(239,68,68,0.10)' },
            power: { line: '#f59e0b', fill: 'rgba(245,158,11,0.10)' },
            status: { line: '#8b5cf6', fill: 'rgba(139,92,246,0.10)' },
            cop: { line: '#10b981', fill: 'rgba(16,185,129,0.10)' },
            default: { line: '#667eea', fill: 'rgba(102,126,234,0.10)' },
        };

        function getSparklineColor(canvas) {
            const metricDiv = canvas.closest('.metric');
            if (!metricDiv) return SPARKLINE_COLORS.default;
            for (const cls of ['temp', 'power', 'cop', 'status']) {
                if (metricDiv.classList.contains(cls)) return SPARKLINE_COLORS[cls];
            }
            return SPARKLINE_COLORS.default;
        }

        function drawSparkline(canvas, dataPoints, colors) {
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const w = canvas.clientWidth;
            const h = canvas.clientHeight;
            const timeAxisHeight = 16; // space for time labels at bottom
            const chartH = h - timeAxisHeight;

            // Set canvas resolution for sharp rendering
            canvas.width = w * dpr;
            canvas.height = h * dpr;
            ctx.scale(dpr, dpr);

            if (!dataPoints || dataPoints.length < 2) {
                // No data ‚Äî draw flat dashed line
                ctx.strokeStyle = '#ddd';
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(0, chartH / 2);
                ctx.lineTo(w, chartH / 2);
                ctx.stroke();
                return;
            }

            const values = dataPoints.map(p => p.value);
            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const range = maxVal - minVal || 1;
            const pad = 3; // vertical padding

            // Map data points to canvas coords
            const points = dataPoints.map((p, i) => ({
                x: (i / (dataPoints.length - 1)) * w,
                y: pad + ((maxVal - p.value) / range) * (chartH - pad * 2),
            }));

            // Fill gradient under line
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
            }
            ctx.lineTo(points[points.length - 1].x, chartH);
            ctx.lineTo(points[0].x, chartH);
            ctx.closePath();
            ctx.fillStyle = colors.fill;
            ctx.fill();

            // Draw line
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
            }
            ctx.strokeStyle = colors.line;
            ctx.lineWidth = 1.5;
            ctx.lineJoin = 'round';
            ctx.stroke();

            // Draw min/max value labels
            ctx.fillStyle = '#999';
            ctx.font = '9px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(maxVal.toFixed(1), w - 2, 9);
            ctx.fillText(minVal.toFixed(1), w - 2, chartH - 2);

            // Draw time labels on x-axis
            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            const timeY = h - 1;

            // Start time (left)
            const startTime = new Date(dataPoints[0].time);
            ctx.textAlign = 'left';
            ctx.fillText(formatTime(startTime), 1, timeY);

            // End time (right)
            const endTime = new Date(dataPoints[dataPoints.length - 1].time);
            ctx.textAlign = 'right';
            ctx.fillText(formatTime(endTime), w - 1, timeY);

            // Mid time (center)
            const midIdx = Math.floor(dataPoints.length / 2);
            const midTime = new Date(dataPoints[midIdx].time);
            ctx.textAlign = 'center';
            ctx.fillText(formatTime(midTime), w / 2, timeY);
        }

        function formatTime(date) {
            return date.getHours().toString().padStart(2, '0') + ':' +
                   date.getMinutes().toString().padStart(2, '0');
        }

        async function loadSparklines() {
            const canvases = document.querySelectorAll('canvas.sparkline');
            if (canvases.length === 0) return;

            // Group canvases by heat pump ID
            const byPump = {};
            canvases.forEach(canvas => {
                const hpId = canvas.dataset.hp;
                if (!byPump[hpId]) byPump[hpId] = [];
                byPump[hpId].push(canvas);
            });

            // Fetch history for each pump (in parallel)
            const fetches = Object.keys(byPump).map(async hpId => {
                try {
                    const mins = sparklineMinutesPerPump[hpId] || DEFAULT_SPARKLINE_MINUTES;
                    const res = await fetch(`/api/heatpumps/${hpId}/history?minutes=${mins}`);
                    const data = await res.json();

                    byPump[hpId].forEach(canvas => {
                        const field = canvas.dataset.field;
                        const points = (data.fields || {})[field] || [];
                        const colors = getSparklineColor(canvas);
                        drawSparkline(canvas, points, colors);
                    });
                } catch (err) {
                    console.error(`Failed to load sparklines for ${hpId}:`, err);
                }
            });

            await Promise.all(fetches);
        }

        async function loadSparklineForPump(hpId) {
            const mins = sparklineMinutesPerPump[hpId] || DEFAULT_SPARKLINE_MINUTES;
            const canvases = document.querySelectorAll(`canvas.sparkline[data-hp="${hpId}"]`);
            if (canvases.length === 0) return;

            try {
                const res = await fetch(`/api/heatpumps/${hpId}/history?minutes=${mins}`);
                const data = await res.json();
                canvases.forEach(canvas => {
                    const field = canvas.dataset.field;
                    const points = (data.fields || {})[field] || [];
                    const colors = getSparklineColor(canvas);
                    drawSparkline(canvas, points, colors);
                });
            } catch (err) {
                console.error(`Failed to load sparklines for ${hpId}:`, err);
            }
        }

        // Check if restart is needed (from localStorage)
        function checkRestartNeeded() {
            if (localStorage.getItem('requiresRestart') === 'true') {
                document.getElementById('restart-banner').classList.add('show');
            }
        }

        // Load available models
        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                const data = await response.json();
                availableModels = data.models || [];
                populateModelSelect();
            } catch (error) {
                console.error('Failed to load models:', error);
                showToast('Failed to load models', 'error');
            }
        }

        function populateModelSelect() {
            const select = document.getElementById('hp-model');
            select.innerHTML = '<option value="">Select a model...</option>';
            availableModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = `${model.name} (${model.register_count} registers)`;
                select.appendChild(option);
            });
        }

        // Load heat pumps for management modal
        async function loadHeatPumpsForManagement() {
            try {
                const response = await fetch('/config/heatpumps.yml');
                if (!response.ok) {
                    // Try loading via a config endpoint if direct file access fails
                    allHeatPumps = [];
                    return;
                }
                // For now, we'll need to fetch config differently
                // Let's use a workaround: create an endpoint or parse from existing data
                allHeatPumps = [];
                showToast('Loading configuration...', 'warning');
            } catch (error) {
                console.error('Failed to load heat pumps:', error);
            }
        }

        // Modal management
        function openManageModal() {
            stopAutoRefresh();
            loadHeatPumpsFromConfig();
            document.getElementById('manage-modal').classList.add('show');
        }

        function closeManageModal() {
            document.getElementById('manage-modal').classList.remove('show');
            startAutoRefresh();
        }

        async function loadHeatPumpsFromConfig() {
            const list = document.getElementById('hp-manage-list');
            list.innerHTML = '<li style="text-align: center; padding: 20px; color: #999;">Loading configuration...</li>';

            try {
                const response = await fetch('/api/heatpumps');
                const data = await response.json();
                allHeatPumps = data.heat_pumps || [];
                renderHeatPumpList();
            } catch (error) {
                console.error('Failed to load heat pumps:', error);
                list.innerHTML = '<li style="text-align: center; padding: 20px; color: #999;">Failed to load configuration</li>';
            }
        }

        function renderHeatPumpList() {
            const list = document.getElementById('hp-manage-list');

            if (allHeatPumps.length === 0) {
                list.innerHTML = '<li style="text-align: center; padding: 20px; color: #999;">No heat pumps configured</li>';
                return;
            }

            list.innerHTML = '';
            allHeatPumps.forEach(hp => {
                const hasData = hp.data && hp.data.timestamp;
                const status = hasData ? 'Online' : 'Offline';
                const statusClass = hasData ? 'color: #10b981' : 'color: #ef4444';

                const li = document.createElement('li');
                li.className = 'hp-list-item';
                li.innerHTML = `
                    <div class="hp-list-info">
                        <div class="hp-list-name">${hp.name}</div>
                        <div class="hp-list-details">
                            üìç ${hp.location} ‚Ä¢ ID: ${hp.id} ‚Ä¢ Model: ${hp.model} ‚Ä¢ <span style="${statusClass}">${status}</span>
                        </div>
                    </div>
                    <div class="hp-list-actions">
                        <button class="btn btn-primary btn-small" onclick="openEditModal('${hp.id}')">Edit</button>
                        <button class="btn btn-danger btn-small" onclick="openDeleteModal('${hp.id}', '${hp.name}')">Delete</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function openAddModal() {
            document.getElementById('form-modal-title').textContent = 'Add Heat Pump';
            document.getElementById('edit-mode').value = 'false';
            document.getElementById('hp-form').reset();
            document.getElementById('hp-id').readOnly = false;
            document.getElementById('hp-enabled').checked = true;
            document.getElementById('display-fields-section').style.display = 'none';
            closeManageModal();
            document.getElementById('form-modal').classList.add('show');
        }

        async function openEditModal(hpId) {
            const hp = allHeatPumps.find(h => h.id === hpId);
            if (!hp) {
                showToast('Heat pump not found', 'error');
                return;
            }

            document.getElementById('form-modal-title').textContent = 'Edit Heat Pump';
            document.getElementById('edit-mode').value = 'true';
            document.getElementById('original-id').value = hpId;
            document.getElementById('hp-id').value = hp.id;
            document.getElementById('hp-id').readOnly = true;
            document.getElementById('hp-name').value = hp.name;
            document.getElementById('hp-location').value = hp.location;
            document.getElementById('hp-model').value = hp.model;
            document.getElementById('hp-enabled').checked = hp.enabled !== false;

            // Populate modbus fields from allHeatPumps data (includes modbus config)
            const modbus = hp.modbus || {};
            document.getElementById('hp-host').value = modbus.host || '';
            document.getElementById('hp-port').value = modbus.port || 502;
            document.getElementById('hp-unit-id').value = modbus.unit_id || 1;
            document.getElementById('hp-timeout').value = modbus.timeout || 5.0;
            document.getElementById('hp-retries').value = modbus.retries || 3;
            document.getElementById('hp-retry-delay').value = modbus.retry_delay || 1.0;

            // Load and display field checklist for this pump
            document.getElementById('display-fields-section').style.display = '';
            await loadFieldsForEditModal(hp);

            closeManageModal();
            document.getElementById('form-modal').classList.add('show');
        }

        // Displayed fields in edit modal
        let editModalFields = [];  // register fields loaded for the edit modal

        async function loadFieldsForEditModal(hp) {
            const container = document.getElementById('hp-fields-checklist');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">Loading fields...</div>';

            try {
                // Load register fields and current visible fields in parallel
                const [regRes, settingsRes] = await Promise.all([
                    fetch(`/api/registers/${hp.model}`),
                    fetch('/api/settings'),
                ]);
                const regData = await regRes.json();
                const settings = await settingsRes.json();

                editModalFields = regData.fields || [];
                const defaultFields = {{ DEFAULT_VISIBLE_FIELDS | tojson }};
                const vf = (settings.display.visible_fields || {})[hp.id] || defaultFields;

                buildEditFieldChecklist(editModalFields, vf);
            } catch (err) {
                console.error('Failed to load fields for edit modal:', err);
                container.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">Failed to load fields</div>';
            }
        }

        function buildEditFieldChecklist(fields, visibleFields) {
            const container = document.getElementById('hp-fields-checklist');
            container.innerHTML = '';

            const categories = {};
            fields.forEach(f => {
                if (!categories[f.category]) categories[f.category] = [];
                categories[f.category].push(f);
            });

            const order = ['Temperatures', 'Pressures', 'Flow', 'Energy', 'Status', 'Configuration'];
            for (const cat of order) {
                const catFields = categories[cat];
                if (!catFields || catFields.length === 0) continue;

                const div = document.createElement('div');
                div.className = 'field-category';
                div.innerHTML = `<div class="field-category-title">${cat}</div>`;

                const list = document.createElement('div');
                list.className = 'field-checkbox-list';
                catFields.forEach(f => {
                    const checked = visibleFields.includes(f.name);
                    const label = document.createElement('label');
                    label.className = 'field-checkbox-item';
                    label.innerHTML = `
                        <input type="checkbox" name="hp_visible_field"
                               value="${f.name}" ${checked ? 'checked' : ''}>
                        <span>${f.description}</span>
                    `;
                    list.appendChild(label);
                });
                div.appendChild(list);
                container.appendChild(div);
            }
        }

        function closeFormModal() {
            document.getElementById('form-modal').classList.remove('show');
            clearFormErrors();
            startAutoRefresh();
        }

        async function saveHeatPump(event) {
            event.preventDefault();
            clearFormErrors();

            const form = document.getElementById('hp-form');
            const formData = new FormData(form);
            const editMode = document.getElementById('edit-mode').value === 'true';
            const originalId = document.getElementById('original-id').value;

            // Build heat pump object
            const heatPump = {
                id: formData.get('id').toLowerCase(),
                name: formData.get('name'),
                location: formData.get('location'),
                model: formData.get('model'),
                enabled: document.getElementById('hp-enabled').checked,
                modbus: {
                    type: 'tcp',
                    host: formData.get('host'),
                    port: parseInt(formData.get('port')),
                    unit_id: parseInt(formData.get('unit_id')),
                    timeout: parseFloat(formData.get('timeout')),
                    retries: parseInt(formData.get('retries')),
                    retry_delay: parseFloat(formData.get('retry_delay'))
                }
            };

            // Disable save button and show loading
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = 'Saving... <span class="loading"></span>';

            try {
                const url = editMode ? `/api/heatpumps/${originalId}` : '/api/heatpumps';
                const method = editMode ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(heatPump)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to save heat pump');
                }

                // If editing, also save the visible fields for this pump
                if (editMode) {
                    const checkedFields = Array.from(
                        document.querySelectorAll('input[name="hp_visible_field"]:checked')
                    ).map(cb => cb.value);

                    if (checkedFields.length > 0) {
                        try {
                            const settingsRes = await fetch('/api/settings');
                            const currentSettings = await settingsRes.json();
                            const visibleFields = currentSettings.display.visible_fields || {};
                            visibleFields[heatPump.id || originalId] = checkedFields;

                            await fetch('/api/settings', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    collector: currentSettings.collector,
                                    display: {
                                        refresh_interval: currentSettings.display.refresh_interval,
                                        sparkline_minutes: currentSettings.display.sparkline_minutes || 30,
                                        visible_fields: visibleFields,
                                    }
                                })
                            });
                        } catch (e) {
                            console.error('Failed to save display fields:', e);
                        }
                    }
                }

                // Success
                showToast(editMode ? 'Heat pump updated successfully' : 'Heat pump created successfully', 'success');
                localStorage.setItem('requiresRestart', 'true');
                closeFormModal();

                // Reload page after short delay to apply field changes
                scheduleReload();

            } catch (error) {
                console.error('Save error:', error);
                showToast(error.message, 'error');
                displayFormError(error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

        function openDeleteModal(hpId, hpName) {
            deleteTarget = hpId;
            document.getElementById('delete-hp-name').textContent = hpName;
            closeManageModal();
            document.getElementById('delete-modal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('show');
            deleteTarget = null;
            startAutoRefresh();
        }

        async function confirmDelete() {
            if (!deleteTarget) return;

            try {
                const response = await fetch(`/api/heatpumps/${deleteTarget}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to delete heat pump');
                }

                showToast('Heat pump deleted successfully', 'success');
                localStorage.setItem('requiresRestart', 'true');
                closeDeleteModal();

                scheduleReload();

            } catch (error) {
                console.error('Delete error:', error);
                showToast(error.message, 'error');
            }
        }

        async function restartCollector() {
            const banner = document.getElementById('restart-banner');
            const btn = banner.querySelector('.btn');
            btn.disabled = true;
            btn.innerHTML = 'Restarting... <span class="loading"></span>';

            try {
                const response = await fetch('/api/collector/restart', {
                    method: 'POST'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to restart collector');
                }

                showToast('Collector restarted successfully', 'success');
                localStorage.removeItem('requiresRestart');
                banner.classList.remove('show');

            } catch (error) {
                console.error('Restart error:', error);
                showToast(error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Restart Collector';
            }
        }

        // Form validation
        function clearFormErrors() {
            document.querySelectorAll('.form-error').forEach(el => {
                el.classList.remove('show');
                el.textContent = '';
            });
            document.querySelectorAll('.form-input').forEach(el => {
                el.classList.remove('error');
            });
        }

        function displayFormError(message) {
            // Try to parse validation errors
            if (message.includes('field')) {
                // Show generic error
                showToast(message, 'error');
            }
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || 'üí°'}</div>
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Settings modal management

        async function openSettingsModal() {
            stopAutoRefresh();

            try {
                const settingsRes = await fetch('/api/settings');
                const settings = await settingsRes.json();

                document.getElementById('setting-poll-interval').value = settings.collector.poll_interval;
                document.getElementById('setting-refresh-interval').value = settings.display.refresh_interval;
                document.getElementById('setting-sparkline-minutes').value = settings.display.sparkline_minutes || 30;

                document.getElementById('settings-modal').classList.add('show');
            } catch (error) {
                console.error('Failed to load settings:', error);
                showToast('Failed to load settings', 'error');
                startAutoRefresh();
            }
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('show');
            startAutoRefresh();
        }

        async function saveSettings() {
            const saveBtn = document.getElementById('settings-save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = 'Saving... <span class="loading"></span>';

            try {
                const pollInterval = parseFloat(
                    document.getElementById('setting-poll-interval').value
                );
                const refreshInterval = parseInt(
                    document.getElementById('setting-refresh-interval').value
                );
                const sparklineMinutes = parseInt(
                    document.getElementById('setting-sparkline-minutes').value
                );

                // Validate
                if (pollInterval < 5 || pollInterval > 120) {
                    showToast('Poll interval must be between 5 and 120 seconds', 'warning');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                    return;
                }
                if (refreshInterval < 5 || refreshInterval > 120) {
                    showToast('Refresh rate must be between 5 and 120 seconds', 'warning');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                    return;
                }
                if (sparklineMinutes < 5 || sparklineMinutes > 480) {
                    showToast('Sparkline time window must be between 5 and 480 minutes', 'warning');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                    return;
                }

                // Load current settings to preserve visible_fields
                const currentRes = await fetch('/api/settings');
                const currentSettings = await currentRes.json();

                // Save to server (preserve existing visible_fields)
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        collector: { poll_interval: pollInterval },
                        display: {
                            refresh_interval: refreshInterval,
                            sparkline_minutes: sparklineMinutes,
                            visible_fields: currentSettings.display.visible_fields || {},
                        }
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to save settings');
                }

                if (data.requires_restart) {
                    localStorage.setItem('requiresRestart', 'true');
                }

                showToast('Settings saved successfully', 'success');
                closeSettingsModal();

                // Reload to apply new refresh interval / sparkline window
                scheduleReload();

            } catch (error) {
                console.error('Save settings error:', error);
                showToast(error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

        // Close modals on overlay click (only if both mousedown and mouseup are on overlay)
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            let mousedownTarget = null;
            overlay.addEventListener('mousedown', (e) => { mousedownTarget = e.target; });
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay && mousedownTarget === overlay) {
                    overlay.classList.remove('show');
                    startAutoRefresh();
                }
            });
        });
    </script>
</body>
</html>
